"use strict";export default class Reflex{constructor({state:t,elements:e=[]}){this.state=t,this.observer={},this.define(e)}get(t){return t.split(".").reduce((t,e)=>t?t[e]:"",this.state)}set(t,e,s=null,i=this.state){if(s||(s=t.split(".")),s.length>1)this.set(t,e,s.slice(1),i[s[0]]);else if(e!==i[s[0]]){const r=i[s[0]];i[s[0]]=e,this.runObserver(t,e,r)}}observe({path:t,handler:e,immediate:s}){this.observer[t]||(this.observer[t]=[]),this.observer[t].push(e),s&&e(this.get(t))}runObserver(t,e,s){this.observer[t]&&this.observer[t].forEach(t=>t(e,s))}define(t){const e=this;t.forEach(t=>{console.log(`x-${t}`),customElements.define(`x-${t}`,class extends document.createElement(t).constructor{constructor(){super(),this.reflex=e}connectedCallback(){const t=`x-${this.nodeName.toLowerCase()}`;if(this.getAttribute("is")!==t&&console.error(`Chance to is="x-${t}"`,this),this.bindAttributes=Array.from(this.attributes).filter(({name:t})=>t.startsWith(":")||"for"===t||"show"===t||"text"===t||"html"===t),this.hasAttribute("for")){const[t,e]=this.getAttribute("for").split(" in ");this.removeAttribute("for"),this.setAttribute("_for",`${t} in ${e}`),this.orginalNode=this.cloneNode(!0),this.setAttribute("for",`${t} in ${e}`),this.removeAttribute("_for")}this._setPaths(),this.render()}render(){let t=!0;this.bindAttributes.forEach(({name:e})=>{const s=this.path[e.replace(":","")],i=s.startsWith("#")?this.closest(`[for^="${s.replace("#","")} in "], `+`[_for^="${s.replace("#","")} in "]`)._index:this.reflex.get(s);if("for"===e||"_for"===e){for(this._index=0,this._renderChilds(this);this.nextSibling._index>0;)this.nextSibling.remove();if(i.length>0&&this.orginalNode)for(let t=i.length-1;t>0;t--){const e=this.orginalNode.cloneNode(!0);e._index=t,this.after(e),this._renderChilds(e)}else t=!1}else"show"!==e||i?"text"===e&&this.textContent!==i?this.textContent=i:"html"===e&&this.innerHTML!==i?this.innerHTML=i:e.startsWith(":")&&(!1===i?this.removeAttribute(e.slice(1)):!0===i?this.setAttribute(e.slice(1),""):":class"===e||":style"===e?this.setAttribute(e.slice(1),this.getAttribute(e.slice(1))+" "+i):this.setAttribute(e.slice(1),i)):t=!1;this[e.slice(1)]!==i&&(this[e.slice(1)]=i)}),t?this.style.removeProperty("display"):this.style.setProperty("display","none")}_renderChilds(t){t.querySelectorAll(`[is^='${e.prefix}-'`).forEach(t=>t.render&&t.render())}_setPaths(){this.path={},this.bindAttributes.forEach(({name:t,value:e})=>{"for"!==t&&"_for"!==t||(e=e.split(" in ")[1]),"show"===t&&(e=e.split(" ")[0]);const s=(t,e=[])=>{const i=t.parentNode&&t.parentNode.closest("[for], [_for]");return i?(e.push(i),s(i,e)):e},i=s(this);(this.hasAttribute("for")||this.hasAttribute("_for"))&&i.unshift(this),i.forEach(t=>{const s=t._index,[i,r]=t.hasAttribute("for")?t.getAttribute("for").split(" in "):t.getAttribute("_for").split(" in ");e=e.replace(new RegExp(`(^|\\.)${i}(\\.|$)`),`$1${r}.${s}$2`)}),this.path[t.replace(":","")]=e,this.reflex.observe({path:e,handler:this.render.bind(this)})})}},{extends:t})})}}